<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.PetHome.mapper.AdoptionApplicationMapper">

    <resultMap id="ApplicationResultMap" type="com.example.PetHome.entity.AdoptionApplication">
        <id property="id" column="id" />
        <result property="petId" column="pet_id" />
        <result property="adopterId" column="adopter_id" />
        <result property="adopterName" column="adopter_name" />
        <result property="adopterPhone" column="adopter_phone" />
        <result property="reason" column="reason" />
        <result property="status" column="status" />
        <result property="applicationTime" column="application_time" />
        <result property="rejectionReason" column="rejection_reason" />
        <result property="petName" column="pet_name" />
    </resultMap>

    <insert id="insertApplication" parameterType="com.example.PetHome.entity.AdoptionApplication" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO adoption_application
        (pet_id, adopter_id, adopter_name, adopter_phone, reason, status, address_id)
        VALUES
            (#{petId}, #{adopterId}, #{adopterName}, #{adopterPhone}, #{reason}, 0, #{addressId})
    </insert>

    <select id="findAllApplications" resultMap="ApplicationResultMap">
        SELECT * FROM adoption_application ORDER BY application_time DESC
    </select>

    <select id="findApplicationsByUserId" resultMap="ApplicationResultMap">
        SELECT app.*, p.name AS pet_name
        FROM adoption_application app
                 LEFT JOIN pet p ON app.pet_id = p.id
        WHERE app.adopter_id = #{adopterId}
        ORDER BY app.application_time DESC
    </select>

    <select id="findApplicationById" resultMap="ApplicationResultMap">
        SELECT * FROM adoption_application WHERE id = #{id}
    </select>

    <update id="updateApplicationStatus">
        UPDATE adoption_application
        SET
            status = #{status},
            rejection_reason = CASE
                                   WHEN #{status} = 2 THEN #{rejectionReason}
                                   ELSE rejection_reason
                END
        WHERE id = #{id}
    </update>
    <update id="resubmitApplicationStatus">
        UPDATE adoption_application
        SET
            status = #{status},
            rejection_reason = CASE
                                   WHEN #{status} = 2 THEN #{rejectionReason}
                                   ELSE NULL
                END
        WHERE id = #{id}
    </update>
    <update id="resubmitApplication" parameterType="com.example.PetHome.entity.AdoptionApplication">
        UPDATE adoption_application
        SET
            adopter_name = #{adopterName},     -- 更新申请人姓名
            adopter_phone = #{adopterPhone},   -- 更新申请人电话
            reason = #{reason},               -- 更新申请理由
            address_id = #{addressId},         -- 更新地址ID
            status = 0,                       -- 将状态重置为 待审核
            application_time = NOW(),          -- 更新申请时间为当前时间
            rejection_reason = NULL
        WHERE id = #{id}                      -- 匹配申请 ID
          AND adopter_id = #{adopterId}        -- 确保是该用户的申请
          AND status = 2                      -- 确保只有已拒绝的申请才能重新提交
    </update>

    <resultMap id="ApplicationDetailResultMap" type="com.example.PetHome.entity.AdminApplicationDetailDTO">
        <id property="id" column="app_id"/>
        <result property="petId" column="app_pet_id"/>
        <result property="adopterId" column="app_adopter_id"/>
        <result property="adopterName" column="app_adopter_name"/>
        <result property="adopterPhone" column="app_adopter_phone"/>
        <result property="reason" column="app_reason"/>
        <result property="status" column="app_status"/>
        <result property="applicationTime" column="app_application_time"/>
        <result property="addressId" column="app_address_id"/>
        <result property="rejectionReason" column="app_rejection_reason"/>
        <result property="petName" column="p_name"/>
        <result property="petType" column="p_type"/>
        <result property="petBreed" column="p_breed"/>
        <result property="petPhotoUrl" column="p_photo_url"/>
        <result property="adopterUsername" column="u_username"/>
        <result property="adopterEmail" column="u_email"/>
        <result property="addressRecipientName" column="addr_recipient_name"/>
        <result property="addressPhone" column="addr_phone"/>
        <result property="addressProvince" column="addr_province"/>
        <result property="addressCity" column="addr_city"/>
        <result property="addressDistrict" column="addr_district"/>
        <result property="addressDetailedAddress" column="addr_detailed_address"/>
        <result property="addressIsDefault" column="addr_is_default"/>
    </resultMap>

    <select id="findApplicationDetailById" resultMap="ApplicationDetailResultMap">
        SELECT
            app.id AS app_id,
            app.pet_id AS app_pet_id,
            app.adopter_id AS app_adopter_id,
            app.adopter_name AS app_adopter_name,
            app.adopter_phone AS app_adopter_phone,
            app.reason AS app_reason,
            app.status AS app_status,
            app.application_time AS app_application_time,
            app.address_id AS app_address_id,
            app.rejection_reason AS app_rejection_reason,
            p.name AS p_name,
            p.type AS p_type,
            p.breed AS p_breed,
            p.photo_url AS p_photo_url,
            u.username AS u_username,
            u.email AS u_email,
            addr.recipient_name AS addr_recipient_name,
            addr.phone AS addr_phone,
            addr.province AS addr_province,
            addr.city AS addr_city,
            addr.district AS addr_district,
            addr.detailed_address AS addr_detailed_address,
            addr.is_default AS addr_is_default
        FROM
            adoption_application app
                LEFT JOIN pet p ON app.pet_id = p.id
                LEFT JOIN user u ON app.adopter_id = u.id
                LEFT JOIN address addr ON app.address_id = addr.id
        WHERE
            app.id = #{id}
    </select>

</mapper>