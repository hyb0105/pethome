<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.PetHome.mapper.PostInteractionMapper">

    <resultMap id="PetPostResultMap" type="com.example.PetHome.entity.PetPost">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="summary" column="summary"/>
        <result property="coverImageUrl" column="cover_image_url"/>
        <result property="authorId" column="author_id"/>
        <result property="status" column="status"/>
        <result property="views" column="views"/>
        <result property="likes" column="likes"/>
        <result property="createTime" column="create_time"/>
        <result property="authorName" column="author_name"/>
        <result property="category" column="category"/>
        <result property="likedByCurrentUser" column="liked_by_current_user"/>
    </resultMap>

    <select id="findLike" resultType="int">
        SELECT COUNT(*) FROM post_like WHERE user_id = #{userId} AND post_id = #{postId}
    </select>

    <insert id="insertLike">
        INSERT INTO post_like (user_id, post_id) VALUES (#{userId}, #{postId})
    </insert>

    <delete id="deleteLike">
        DELETE FROM post_like WHERE user_id = #{userId} AND post_id = #{postId}
    </delete>

    <select id="findLikedPostsByUserId" resultMap="PetPostResultMap">
        SELECT
            p.*,
            u.username AS author_name,
            (pl_check.user_id IS NOT NULL) AS liked_by_current_user
        FROM post_like pl
                 INNER JOIN pet_post p ON pl.post_id = p.id
                 LEFT JOIN user u ON p.author_id = u.id
                 LEFT JOIN post_like pl_check ON p.id = pl_check.post_id AND pl_check.user_id = #{currentUserId}
        WHERE pl.user_id = #{userId} AND p.status = 1
        ORDER BY p.create_time DESC
    </select>

    <select id="findLastViewDate" resultType="String">
        SELECT last_viewed FROM post_view WHERE user_id = #{userId} AND post_id = #{postId}
    </select>

    <insert id="insertView">
        INSERT INTO post_view (user_id, post_id, last_viewed) VALUES (#{userId}, #{postId}, CURDATE())
    </insert>

    <update id="updateView">
        UPDATE post_view SET last_viewed = CURDATE() WHERE user_id = #{userId} AND post_id = #{postId}
    </update>
</mapper>